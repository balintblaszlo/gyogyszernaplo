<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gy√≥gyszernapl√≥</title>
    <style>
        :root { --main-color: #0056b3; --accent: #004494; --success: #28a745; --warning: #ffc107; --danger: #dc3545; --bg: #f4f7f6; --text-muted: #6c757d; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: #333; -webkit-user-select: none; padding-bottom: 100px; }
        
        /* FEJL√âC */
        header { background: var(--main-color); color: white; padding: 15px; padding-bottom: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: sticky; top:0; z-index:100; }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }
        .doc-name { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; font-weight: normal; }
        
        /* K√ÅRTY√ÅK */
        .container { padding: 12px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); border-left: 6px solid #ccc; position: relative; }
        
        /* √ÅLLAPOTOK */
        .status-waiting { border-left-color: var(--warning); }
        .status-due { border-left-color: var(--danger); animation: pulse 2s infinite; }
        .status-done { border-left-color: var(--success); opacity: 0.6; background: #f9fff9; }
        .type-acute { border: 2px solid #ffeeba; border-left: 6px solid #fd7e14 !important; background: #fffbf2; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        .med-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .med-name { font-size: 1.2rem; font-weight: bold; color: #222; }
        .med-time { font-size: 1.5rem; color: var(--main-color); font-weight: bold; white-space: nowrap; margin-left: 10px; }
        .course-info { font-size: 0.85rem; color: #d63384; font-weight: bold; margin-top: 5px; }

        /* GOMBOK */
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; border: none; padding: 14px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; -webkit-tap-highlight-color: transparent; display: flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.97); }
        .btn-take { background: var(--success); box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); }
        .btn-snooze { background: var(--warning); color: #333; flex: 0.6; }
        .btn-block { width: 100%; margin-top: 10px; padding: 15px; font-size: 1.1rem; background: var(--main-color); }
        .btn-outline { background: white; border: 2px solid var(--main-color); color: var(--main-color); }
        .btn-email { background: #007bff; margin-top: 5px; }
        
        /* Halaszt√°s almen√º */
        .snooze-options { display: flex; gap: 5px; animation: fadein 0.2s; }
        .btn-snooze-opt { background: #ffeeba; color: #333; font-size: 0.9rem; padding: 10px; border: 1px solid #ffc107; }

        /* INPUTOK */
        .form-group { margin-bottom: 20px; }
        label { font-size: 1rem; font-weight: bold; color: #333; display: block; margin-bottom: 6px; }
        .help-text { font-size: 0.85rem; color: var(--text-muted); font-style: italic; margin-bottom: 8px; display: block; line-height: 1.3; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: white; box-sizing: border-box; }
        
        /* ANTIBIOTIKUM & MODE SELECTOR */
        .type-selector { display: flex; gap: 10px; margin-bottom: 10px; }
        .type-option { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; color: #666; }
        .type-option.selected { border-color: var(--main-color); background: #eef4fb; color: var(--main-color); }
        .type-option.selected-acute { border-color: #fd7e14; background: #fff5eb; color: #fd7e14; }

        /* STATISZTIKA PROGESS BAR */
        .stat-row { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .stat-header { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; }
        .progress-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .stat-details { font-size: 0.8rem; color: #666; margin-top: 3px; }

        /* INFO TAB ST√çLUSOK */
        .info-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .info-section h4 { margin-bottom: 10px; color: var(--main-color); }
        .info-section p, .info-section li { font-size: 0.9rem; line-height: 1.5; color: #444; }
        .alert-text { color: var(--danger); font-weight: bold; background: #fff0f0; padding: 10px; border-radius: 8px; border: 1px solid #ffcaca; }

        /* TABOK */
        .tab-content { display: none; animation: fadein 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadein { from { opacity:0; } to { opacity:1; } }

        /* MEN√ú */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #ddd; display: flex; height: 75px; z-index: 9999; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 0.75rem; cursor: pointer; } /* Kisebb bet≈± a 4 gomb miatt */
        .nav-item.active { color: var(--main-color); font-weight: bold; background: #f0f7ff; }
        .icon { font-size: 1.6rem; margin-bottom: 4px; }
        
        /* JOGI MODAL */
        #legal-modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; max-width: 500px; text-align: center; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <h1>Gy√≥gyszernapl√≥</h1>
    <div class="doc-name" id="header-doc-name">H√°ziorvos: Nincs be√°ll√≠tva</div>
</header>

<div class="container">
    
    <div id="tab-today" class="tab-content active">
        <div id="today-header" style="text-align:center; margin-bottom:15px; font-size:0.95rem; color:#666; font-weight:bold;"></div>
        <div id="today-list"></div>
        <div style="text-align: center; margin-top: 50px; color: #888;" id="empty-msg">
            <div style="font-size: 4rem; margin-bottom: 10px;">‚úÖ</div>
            <div>M√°ra nincs (t√∂bb) teend≈ë.</div>
        </div>
    </div>

    <div id="tab-history" class="tab-content">
        <div class="card" style="border-left-color: var(--main-color);">
            <h3>üë®‚Äç‚öïÔ∏è Ter√°pia Elemz√©s (30 nap)</h3>
            <div id="dashboard-stats"></div>
        </div>

        <h3 style="margin: 20px 5px 10px;">Napl√≥ K√ºld√©se</h3>
        <div class="card" style="border-left: 5px solid #666;">
            <p style="font-size:0.9rem; margin-top:0;">K√ºldje el adatait orvos√°nak k√©t l√©p√©sben:</p>
            <button onclick="exportData()" class="btn-block" style="background:#444">üì• 1. Adatok let√∂lt√©se</button>
            <div class="help-text" style="text-align:center;">Excel (CSV) form√°tumban menti a statisztik√°t √©s a napl√≥t.</div>
            <button onclick="prepareEmail()" class="btn-block btn-email">üìß 2. Email meg√≠r√°sa</button>
            <div class="help-text" style="text-align:center;"><b>Ne felejtse el csatolni a let√∂lt√∂tt f√°jlt!</b></div>
        </div>

        <h3 style="margin: 20px 5px 10px;">R√©szletes El≈ëzm√©nyek</h3>
        <table style="width:100%; font-size:0.85rem; border-collapse: collapse; background:white;">
            <thead style="background:#eee;"><tr><th style="padding:8px; text-align:left">Mikor</th><th style="padding:8px; text-align:left">Mit</th><th>Ok</th></tr></thead>
            <tbody id="history-table"></tbody>
        </table>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="card">
            <h3>ü™™ Adatok</h3>
            <label>Napl√≥ t√≠pusa</label>
            <div class="type-selector">
                <div class="type-option selected" id="opt-adult" onclick="setPatientMode('adult')">Saj√°t magam</div>
                <div class="type-option" id="opt-child" onclick="setPatientMode('child')">Gyermekem</div>
            </div>
            <div class="form-group">
                <label id="lbl-pat-name">Beteg Neve</label>
                <input type="text" id="pat-name" placeholder="pl. Kov√°cs J√°nos" onchange="saveSettings()">
            </div>
            <div class="form-group">
                <label>TAJ Sz√°m</label>
                <input type="text" id="pat-taj" placeholder="000-000-000" onchange="saveSettings()">
            </div>
            <div class="form-group">
                <label>H√°ziorvos Neve</label>
                <input type="text" id="doc-name" placeholder="pl. Dr. Minta √âva" onchange="saveSettings()">
            </div>
            <div class="form-group">
                <label>Rendel≈ë Email c√≠me</label>
                <input type="email" id="doc-email" placeholder="orvos@pelda.hu" onchange="saveSettings()">
            </div>
        </div>

        <div class="card" style="border-left: 5px solid var(--success);">
            <h3 style="margin-top:0" id="form-title">üíä √öj gy√≥gyszer felv√©tele</h3>
            <input type="hidden" id="edit-id"> 
            <label>Ter√°pia t√≠pusa</label>
            <div class="type-selector">
                <div class="type-option selected" id="opt-chronic" onclick="setMedType('chronic')">√Ålland√≥ / Kr√≥nikus</div>
                <div class="type-option" id="opt-acute" onclick="setMedType('acute')">K√∫ra / Antibiotikum</div>
            </div>
            <div class="form-group"><label>Gy√≥gyszer neve</label><input type="text" id="new-name" placeholder="pl. Augmentin"></div>
            <div class="form-group"><label>D√≥zis / Mennyis√©g</label><input type="text" id="new-dose" placeholder="pl. 1000mg"></div>
            <div id="acute-settings" style="display:none; background:#fffbf2; padding:10px; border:1px dashed #fd7e14; border-radius:8px; margin-bottom:15px;">
                <label style="color:#d63384">K√∫ra kezdete</label><input type="date" id="new-start-date">
                <label style="color:#d63384">K√∫ra hossza (nap)</label><input type="number" id="new-duration" value="7">
            </div>
            <label>Mikor kell bevenni?</label>
            <div id="time-container"></div>
            <button class="btn-outline" style="padding:10px; width:100%; margin-top:5px;" onclick="addTimeField()">+ Tov√°bbi id≈ëpont</button>
            <button class="btn-block" id="save-btn" onclick="saveMedication()">Hozz√°ad√°s</button>
            <button id="cancel-btn" class="btn-block" style="background:#6c757d; display:none;" onclick="resetForm()">M√©gsem</button>
        </div>
        
        <h3 style="margin: 20px 10px 10px;">Mentett gy√≥gyszerek</h3>
        <div id="settings-list"></div>
        <div style="text-align:center; margin-top:40px; margin-bottom:20px;">
            <a href="#" onclick="hardReset()" style="color:#dc3545; font-size:0.9rem; text-decoration:underline; font-weight:bold;">‚ö†Ô∏è Adatok t√∂rl√©se (Reset)</a>
        </div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="card">
            <h3>‚ÑπÔ∏è Inform√°ci√≥ √©s Seg√≠ts√©g</h3>
            
            <div class="info-section">
                <div class="alert-text">
                    ‚ö†Ô∏è FONTOS: Az adatok elveszt√©s√©nek elker√ºl√©se<br>
                    <span style="font-weight:normal; font-size:0.85rem;">
                        Ez az alkalmaz√°s nem t√°rol adatokat az interneten, minden kiz√°r√≥lag az √ñn telefonj√°n van.
                        Ha t√∂rli a b√∂ng√©sz≈ëj√©ben az "El≈ëzm√©nyeket √©s Webhelyadatokat" (vagy telefontiszt√≠t√≥ appot haszn√°l), 
                        <b>a Gy√≥gyszernapl√≥ adatai is t√∂rl≈ëdnek!</b><br>
                        Javasoljuk, hogy hetente t√∂ltse le a napl√≥t (Adatok let√∂lt√©se gomb). A let√∂lt√∂tt f√°jlok megmaradnak.
                    </span>
                </div>
            </div>

            <div class="info-section">
                <h4>Hogyan m≈±k√∂dik?</h4>
                <ul style="padding-left:20px;">
                    <li><b>Mai teend≈ëk:</b> Itt l√°tja az aktu√°lis gy√≥gyszereket. Ha bevette, nyomjon a "Bevettem" gombra.</li>
                    <li><b>Halaszt√°s:</b> Ha nem tudja azonnal bevenni, v√°laszthat 15-30-60 perces eml√©keztet≈ët.</li>
                    <li><b>Elfelejtett gy√≥gyszer:</b> Ha nem pip√°lja ki √©jf√©lig, a rendszer "Kihagyva" st√°tusszal r√∂gz√≠ti.</li>
                    <li><b>K√∫ra / Antibiotikum:</b> A rendszer visszasz√°mol, √©s a k√∫ra v√©g√©n automatikusan le√°ll√≠tja a gy√≥gyszert.</li>
                </ul>
            </div>

            <div class="info-section">
                <h4>Adatv√©delem √©s Biztons√°g</h4>
                <p>Az alkalmaz√°s egy z√°rt l√°nc√∫ rendszer. A r√∂gz√≠tett nevek, TAJ sz√°mok √©s gy√≥gyszeradatok nem ker√ºlnek semmilyen k√∂zponti szerverre. Az adatokhoz csak √ñn f√©r hozz√°, illetve akinek √ñn elk√ºldi (pl. h√°ziorvosa).</p>
            </div>

            <div class="info-section">
                <h4>Jogi Nyilatkozat</h4>
                <p>Ez a szoftver egy ingyenes, lakoss√°gi seg√©deszk√∂z, <b>NEM min≈ës√ºl orvostechnikai eszk√∂znek</b>. A fejleszt≈ëk √©s a terjeszt≈ëk a szoftvert "ahogy van" (as is) alapon bocs√°tj√°k rendelkez√©sre, mindennem≈± garanciav√°llal√°s n√©lk√ºl.</p>
                <p>A gy√≥gyszerek pontos adagol√°s√°√©rt √©s bev√©tel√©√©rt kiz√°r√≥lag a felhaszn√°l√≥ felel≈ës. K√©ts√©g eset√©n, vagy ha rosszul √©rzi mag√°t, azonnal forduljon kezel≈ëorvos√°hoz vagy h√≠vja az orvosi √ºgyeletet!</p>
                <p><b>Kapcsolattart√°s:</b> K√©rd√©seivel forduljon h√°ziorvos√°hoz.</p>
            </div>
            
            <div style="text-align:center; color:#888; font-size:0.8rem; margin-top:20px;">
                Verzi√≥: 0.8<br>
                Licenc: balintblaszlo 2025, MIT licensz
            </div>
        </div>
    </div>

</div>

<div id="legal-modal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Fontos Figyelmeztet√©s</h3>
        <p>Ez az alkalmaz√°s <b>NEM orvostechnikai eszk√∂z</b>. Kiz√°r√≥lag az √∂nmenedzsel√©st seg√≠t≈ë elektronikus napl√≥.</p>
        <p>Az adatok kiz√°r√≥lag az √ñn telefonj√°n t√°rol√≥dnak. A b√∂ng√©sz√©si el≈ëzm√©nyek t√∂rl√©se adatveszt√©ssel j√°rhat!</p>
        <button class="btn-block" onclick="acceptLegal()">Meg√©rtettem √©s Elfogadom</button>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="switchTab('tab-today', this)">
        <span class="icon">üíä</span> Mai
    </div>
    <div class="nav-item" onclick="switchTab('tab-history', this)">
        <span class="icon">üìä</span> Orvosnak
    </div>
    <div class="nav-item" onclick="switchTab('tab-settings', this)">
        <span class="icon">‚öôÔ∏è</span> Be√°ll√≠t√°s
    </div>
    <div class="nav-item" onclick="switchTab('tab-info', this)">
        <span class="icon">‚ÑπÔ∏è</span> Inf√≥
    </div>
</nav>

<script>
    // --- ADATMODELL V8 ---
    let appData = {
        patient: { name: "", taj: "", docName: "", docEmail: "", isChild: false },
        medications: [],
        history: [], // {date, time, name, status, dose} <- √öJ: dose mez≈ë
        legalAccepted: false
    };
    
    let dailyState = { date: "", items: [] };
    const STORAGE_KEY = 'med_diary_v8';

    function init() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                appData = { ...appData, ...parsed };
                // Biztos√≠tjuk, hogy meglegyenek a mez≈ëk
                if(!appData.patient) appData.patient = { name: "", taj: "", docName: "", docEmail: "", isChild: false };
            } catch(e) { console.error("Data error", e); }
        }

        if(appData.legalAccepted) { document.getElementById('legal-modal').style.display = 'none'; }

        setPatientMode(appData.patient.isChild ? 'child' : 'adult');
        updateHeader();
        
        document.getElementById('pat-name').value = appData.patient.name || "";
        document.getElementById('pat-taj').value = appData.patient.taj || "";
        document.getElementById('doc-name').value = appData.patient.docName || "";
        document.getElementById('doc-email').value = appData.patient.docEmail || "";

        initDay();
        renderAll();
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        localStorage.setItem('med_daily_v8', JSON.stringify(dailyState));
        updateHeader();
    }

    function acceptLegal() {
        appData.legalAccepted = true;
        document.getElementById('legal-modal').style.display = 'none';
        saveData();
    }

    function updateHeader() {
        const doc = appData.patient.docName || "Nincs be√°ll√≠tva";
        document.getElementById('header-doc-name').innerText = "H√°ziorvos: " + doc;
    }

    function initDay() {
        const todayStr = new Date().toISOString().split('T')[0];
        const storedDaily = localStorage.getItem('med_daily_v8');
        
        if(storedDaily) { 
            const prevDaily = JSON.parse(storedDaily);
            if (prevDaily.date && prevDaily.date !== todayStr) {
                logMissedDoses(prevDaily);
                generateDailyTasks(todayStr); 
            } else {
                dailyState = prevDaily;
            }
        } else {
            generateDailyTasks(todayStr); 
        }
        
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('today-header').innerText = new Date().toLocaleDateString('hu-HU', options);
    }

    function logMissedDoses(prevDaily) {
        prevDaily.items.forEach(item => {
            if(item.status === 'waiting') {
                appData.history.unshift({
                    date: prevDaily.date,
                    time: item.time,
                    name: item.name,
                    dose: item.dose, // D√≥zis ment√©se
                    status: 'Kihagyva'
                });
            }
        });
        if(appData.history.length > 500) appData.history = appData.history.slice(0, 500);
        saveData();
    }

    function generateDailyTasks(dateStr) {
        const today = new Date(dateStr);
        const dayOfWeek = today.getDay(); 
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        let items = [];

        appData.medications.forEach(med => {
            let isCourseActive = true;
            let courseDay = 0;

            if (med.type === 'acute') {
                const start = new Date(med.startDate);
                const diffTime = Math.abs(today - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const endDate = new Date(start);
                endDate.setDate(start.getDate() + (parseInt(med.duration)-1));
                
                if (today < start || today > endDate) isCourseActive = false;
                else courseDay = diffDays;
            }

            if (!isCourseActive) return;

            med.times.forEach(tObj => {
                let shouldAdd = false;
                if (tObj.type === 'all') shouldAdd = true;
                if (tObj.type === 'weekday' && !isWeekend) shouldAdd = true;
                if (tObj.type === 'weekend' && isWeekend) shouldAdd = true;

                if (shouldAdd) {
                    items.push({
                        uid: Math.random().toString(36).substr(2, 9),
                        medId: med.id,
                        name: med.name,
                        dose: med.dose,
                        type: med.type,
                        courseInfo: med.type === 'acute' ? `${courseDay}. nap / ${med.duration}` : null,
                        time: tObj.t,
                        status: 'waiting'
                    });
                }
            });
        });

        items.sort((a,b) => a.time.localeCompare(b.time));
        dailyState = { date: dateStr, items: items };
        saveData();
    }

    function setPatientMode(mode) {
        const isChild = (mode === 'child');
        appData.patient.isChild = isChild;
        document.getElementById('opt-adult').className = isChild ? 'type-option' : 'type-option selected';
        document.getElementById('opt-child').className = isChild ? 'type-option selected' : 'type-option';
        document.getElementById('lbl-pat-name').innerText = isChild ? "Gyermek Neve" : "Beteg Neve";
        saveSettings();
    }

    function saveSettings() {
        appData.patient.name = document.getElementById('pat-name').value;
        appData.patient.taj = document.getElementById('pat-taj').value;
        appData.patient.docName = document.getElementById('doc-name').value;
        appData.patient.docEmail = document.getElementById('doc-email').value;
        saveData();
    }

    let currentType = 'chronic';
    function setMedType(type) {
        currentType = type;
        document.querySelectorAll('.type-option').forEach(el => {
           if(el.id.startsWith('opt-c') || el.id.startsWith('opt-a')) el.classList.remove('selected', 'selected-acute');
        });
        
        if(type === 'chronic') {
            document.getElementById('opt-chronic').classList.add('selected');
            document.getElementById('acute-settings').style.display = 'none';
        } else {
            document.getElementById('opt-acute').classList.add('selected-acute');
            document.getElementById('acute-settings').style.display = 'block';
            document.getElementById('new-start-date').value = new Date().toISOString().split('T')[0];
        }
    }

    function addTimeField(val="08:00", type="all") {
        const div = document.createElement('div');
        div.className = 'type-selector';
        div.style.marginBottom = "5px";
        div.innerHTML = `
            <input type="time" class="t-val" value="${val}">
            <select class="t-type">
                <option value="all" ${type=='all'?'selected':''}>Minden nap</option>
                <option value="weekday" ${type=='weekday'?'selected':''}>H√©tk√∂znap</option>
                <option value="weekend" ${type=='weekend'?'selected':''}>H√©tv√©ge</option>
            </select>
            <button class="btn-delete" style="flex:0.3; margin:0;" onclick="this.parentElement.remove()">X</button>
        `;
        document.getElementById('time-container').appendChild(div);
    }

    function saveMedication() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('new-name').value;
        const dose = document.getElementById('new-dose').value;
        
        let times = [];
        document.querySelectorAll('#time-container > div').forEach(row => {
            times.push({ t: row.querySelector('.t-val').value, type: row.querySelector('.t-type').value });
        });

        if(!name || times.length === 0) return alert('N√©v √©s id≈ëpont k√∂telez≈ë!');

        let medObj = { id: id ? parseInt(id) : Date.now(), name, dose, times, type: currentType };

        if(currentType === 'acute') {
            medObj.startDate = document.getElementById('new-start-date').value;
            medObj.duration = document.getElementById('new-duration').value;
        }

        if(id) {
            const idx = appData.medications.findIndex(m => m.id == id);
            appData.medications[idx] = medObj;
            dailyState.items = dailyState.items.filter(i => !(i.medId == id && i.status == 'waiting'));
        } else {
            appData.medications.push(medObj);
        }
        
        generateDailyTasks(dailyState.date);
        saveData(); resetForm(); renderAll(); alert('R√∂gz√≠tve!'); switchTab('tab-settings', document.querySelectorAll('.nav-item')[2]);
    }

    function editMed(id) {
        const med = appData.medications.find(m => m.id == id);
        if(!med) return;
        document.getElementById('edit-id').value = med.id;
        document.getElementById('new-name').value = med.name;
        document.getElementById('new-dose').value = med.dose;
        setMedType(med.type || 'chronic');
        if(med.type === 'acute') {
            document.getElementById('new-start-date').value = med.startDate;
            document.getElementById('new-duration').value = med.duration;
        }
        document.getElementById('time-container').innerHTML = '';
        med.times.forEach(t => addTimeField(t.t, t.type));
        document.getElementById('form-title').innerText = 'Szerkeszt√©s';
        document.getElementById('save-btn').innerText = 'Ment√©s';
        document.getElementById('cancel-btn').style.display = 'block';
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('new-name').value = '';
        document.getElementById('new-dose').value = '';
        document.getElementById('time-container').innerHTML = '';
        setMedType('chronic');
        addTimeField();
        document.getElementById('form-title').innerText = 'üíä √öj gy√≥gyszer';
        document.getElementById('save-btn').innerText = 'Hozz√°ad√°s';
        document.getElementById('cancel-btn').style.display = 'none';
    }

    function deleteMed(id) {
        if(confirm('Biztosan t√∂rli?')) {
            appData.medications = appData.medications.filter(m => m.id != id);
            dailyState.items = dailyState.items.filter(i => i.medId != id);
            saveData(); renderAll();
        }
    }

    function takeMed(uid) {
        const item = dailyState.items.find(i => i.uid == uid);
        if(item) {
            item.status = 'done';
            appData.history.unshift({
                date: dailyState.date,
                time: new Date().toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'}),
                name: item.name,
                dose: item.dose, // Mentj√ºk a d√≥zist is
                status: 'Bev√©ve'
            });
            saveData(); renderAll();
        }
    }

    function showSnooze(uid) {
        const btnContainer = document.getElementById(`btn-group-${uid}`);
        btnContainer.innerHTML = `
            <div class="snooze-options">
                <button class="btn-snooze-opt" onclick="applySnooze('${uid}', 15)">+15p</button>
                <button class="btn-snooze-opt" onclick="applySnooze('${uid}', 30)">+30p</button>
                <button class="btn-snooze-opt" onclick="applySnooze('${uid}', 60)">+1√≥</button>
                <button class="btn-snooze-opt" style="background:#ddd" onclick="renderToday()">X</button>
            </div>
        `;
    }

    function applySnooze(uid, mins) {
        const item = dailyState.items.find(i => i.uid == uid);
        if(item) {
            let [h, m] = item.time.split(':').map(Number);
            let d = new Date(); d.setHours(h, m + mins);
            let nh = String(d.getHours()).padStart(2,'0');
            let nm = String(d.getMinutes()).padStart(2,'0');
            item.time = `${nh}:${nm}`;
            saveData(); renderAll();
        }
    }

    // --- RENDER ---
    function renderAll() {
        renderToday(); renderSettingsList(); renderHistory(); renderDashboard();
    }

    function renderToday() {
        const list = document.getElementById('today-list');
        list.innerHTML = '';
        const now = new Date();
        const currentHm = now.getHours() * 60 + now.getMinutes();
        let hasItems = false;

        dailyState.items.forEach(item => {
            hasItems = true;
            const div = document.createElement('div');
            let statusClass = 'status-waiting';
            
            let [h, m] = item.time.split(':').map(Number);
            if(item.status == 'waiting' && currentHm >= (h*60+m)) statusClass = 'status-due';
            if(item.status == 'done') statusClass = 'status-done';

            let typeClass = item.type === 'acute' ? 'type-acute' : '';
            let acuteBadge = item.type === 'acute' ? `<div class="acute-badge">K√∫ra</div>` : '';
            let courseText = item.courseInfo ? `<div class="course-info">üìÖ ${item.courseInfo}</div>` : '';

            let btns = '';
            if(item.status == 'waiting') {
                btns = `<div class="btn-group" id="btn-group-${item.uid}"><button class="btn-take" onclick="takeMed('${item.uid}')">‚úî Bevettem</button><button class="btn-snooze" onclick="showSnooze('${item.uid}')">üí§ Halaszt</button></div>`;
            } else {
                btns = `<div style="color:green; font-weight:bold; margin-top:10px;">‚úÖ BEV√âVE</div>`;
            }

            div.className = `card ${statusClass} ${typeClass}`;
            div.innerHTML = `${acuteBadge}<div class="med-header"><div><div class="med-name">${item.name}</div><div class="med-details">${item.dose}</div>${courseText}</div><div class="med-time">${item.time}</div></div>${btns}`;
            list.appendChild(div);
        });
        document.getElementById('empty-msg').style.display = hasItems ? 'none' : 'block';
    }

    function renderSettingsList() {
        const list = document.getElementById('settings-list');
        list.innerHTML = '';
        appData.medications.forEach(m => {
            let tags = m.times.map(t => `<span style="background:#eee; padding:2px 5px; border-radius:4px; font-size:0.8rem; margin-right:5px;">‚è∞ ${t.t}</span>`).join('');
            let typeLabel = m.type === 'acute' ? '<b style="color:#fd7e14">[K√öRA]</b>' : '<b>[Kr√≥nikus]</b>';
            list.innerHTML += `<div class="card" style="padding:10px;"><div style="display:flex; justify-content:space-between;"><div>${typeLabel} ${m.name} (${m.dose})</div><div><button class="btn-edit btn-action" onclick="editMed(${m.id})">‚úèÔ∏è</button><button class="btn-delete btn-action" onclick="deleteMed(${m.id})">üóëÔ∏è</button></div></div><div style="margin-top:5px;">${tags}</div></div>`;
        });
    }

    function renderHistory() {
        const tbody = document.getElementById('history-table');
        tbody.innerHTML = '';
        appData.history.slice(0, 30).forEach(h => {
            let color = h.status === 'Bev√©ve' ? 'green' : (h.status === 'Kihagyva' ? 'red' : 'orange');
            let icon = h.status === 'Bev√©ve' ? '‚úî' : '‚ùå';
            tbody.innerHTML += `<tr><td>${h.date}<br>${h.time}</td><td><b>${h.name}</b><br><small>${h.dose || ''}</small></td><td style="color:${color}">${icon}</td></tr>`;
        });
    }

    function calculateStats() {
        let stats = {};
        appData.history.forEach(h => {
            if(!stats[h.name]) stats[h.name] = { total: 0, taken: 0 };
            stats[h.name].total++;
            if(h.status === 'Bev√©ve') stats[h.name].taken++;
        });
        return stats;
    }

    function renderDashboard() {
        const div = document.getElementById('dashboard-stats');
        div.innerHTML = '';
        let stats = calculateStats();
        if(Object.keys(stats).length === 0) {
            div.innerHTML = '<div style="text-align:center; color:#777;">M√©g nincs el√©g adat a statisztik√°hoz.</div>';
            return;
        }
        for (const [name, data] of Object.entries(stats)) {
            let percent = Math.round((data.taken / data.total) * 100);
            let color = percent < 70 ? '#dc3545' : (percent < 90 ? '#ffc107' : '#28a745');
            div.innerHTML += `<div class="stat-row"><div class="stat-header"><span>${name}</span><span style="color:${color}">${percent}% (${data.taken}/${data.total})</span></div><div class="progress-bg"><div class="progress-fill" style="width:${percent}%; background:${color}"></div></div></div>`;
        }
    }

    window.switchTab = function(tabId, navElem) {
        document.querySelectorAll('.tab-content').forEach(d => {d.style.display='none'; d.classList.remove('active')});
        document.getElementById(tabId).style.display='block';
        setTimeout(() => document.getElementById(tabId).classList.add('active'), 10);
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(navElem) navElem.classList.add('active');
        window.scrollTo(0,0);
    }

    window.exportData = function() {
        const name = (appData.patient.name || "Beteg").replace(/ /g, "_");
        const date = new Date().toISOString().split('T')[0];
        const filename = `Naplo_${name}_${date}.csv`;
        
        let csv = "\uFEFF"; // BOM
        // 1. FEJL√âC
        csv += `BETEG ADATAI\n`;
        csv += `Nev:,${appData.patient.name || '-'}\n`;
        csv += `TAJ:,${appData.patient.taj || '-'}\n`;
        csv += `Haziorvos:,${appData.patient.docName || '-'}\n\n`;
        
        // 2. STATISZTIKA
        csv += `--- OSSZESITETT STATISZTIKA (Utolso 30 bejegyzes alapjan) ---\n`;
        csv += `Gyogyszer,Osszes alkalom,Bevett alkalom,Sikeresseg %\n`;
        let stats = calculateStats();
        for (const [mName, data] of Object.entries(stats)) {
            let pct = Math.round((data.taken / data.total) * 100);
            csv += `${mName},${data.total},${data.taken},${pct}%\n`;
        }
        csv += `\n`;

        // 3. R√âSZLETES NAPL√ì
        csv += `--- RESZLETES NAPLO ---\n`;
        csv += `Datum,Ido,Gyogyszer,Dozis,Statusz\n`; 
        appData.history.forEach(row => { 
            // Visszamen≈ëleges d√≥zis keres√©s ha hi√°nyozna (r√©gi adatokn√°l)
            let dose = row.dose || "";
            if(!dose) {
                let med = appData.medications.find(m => m.name === row.name);
                if(med) dose = med.dose;
            }
            csv += `${row.date},${row.time},${row.name},${dose},${row.status}\n`; 
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        alert("F√°jl let√∂ltve! Most k√ºldje el emailben.");
    }

    window.prepareEmail = function() {
        const email = appData.patient.docEmail;
        if(!email) return alert("Adja meg az orvos email c√≠m√©t a Be√°ll√≠t√°sokban!");
        const name = appData.patient.name || "[N√©v]";
        const subj = `Gy√≥gyszernapl√≥: ${name}`;
        const body = `Tisztelt Doktor √ör/N≈ë!%0D%0A%0D%0AMell√©kelten k√ºld√∂m a gy√≥gyszernapl√≥mat.%0D%0A%0D%0ABeteg: ${name}`;
        window.location.href = `mailto:${email}?subject=${subj}&body=${body}`;
    }

    window.hardReset = function() {
        if(confirm("Minden adat t√∂rl√©se?")) { localStorage.removeItem(STORAGE_KEY); localStorage.removeItem('med_daily_v8'); location.reload(); }
    }

    if(document.getElementById('time-container').children.length === 0) addTimeField();
    init();
    setInterval(() => { initDay(); renderToday(); }, 60000);

</script>
</body>
</html>
