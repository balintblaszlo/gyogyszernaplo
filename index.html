<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gy√≥gyszernapl√≥</title>
    <style>
        :root { --main-color: #0056b3; --accent: #004494; --success: #28a745; --warning: #ffc107; --danger: #dc3545; --bg: #f4f7f6; --text-muted: #6c757d; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: #333; -webkit-user-select: none; padding-bottom: 100px; }
        
        /* FEJL√âC */
        header { background: var(--main-color); color: white; padding: 15px; padding-bottom: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: sticky; top:0; z-index:100; }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }
        .doc-name { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; font-weight: normal; }
        
        /* K√ÅRTY√ÅK */
        .container { padding: 12px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); border-left: 6px solid #ccc; position: relative; }
        
        /* √ÅLLAPOTOK */
        .status-waiting { border-left-color: var(--warning); }
        .status-due { border-left-color: var(--danger); animation: pulse 2s infinite; }
        .status-done { border-left-color: var(--success); opacity: 0.6; background: #f9fff9; }
        .type-acute { border: 2px solid #ffeeba; border-left: 6px solid #fd7e14 !important; background: #fffbf2; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        .med-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .med-name { font-size: 1.2rem; font-weight: bold; color: #222; }
        .med-time { font-size: 1.5rem; color: var(--main-color); font-weight: bold; white-space: nowrap; margin-left: 10px; }
        .course-info { font-size: 0.85rem; color: #d63384; font-weight: bold; margin-top: 5px; }

        /* GOMBOK */
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; border: none; padding: 14px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; -webkit-tap-highlight-color: transparent; display: flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.97); }
        .btn-take { background: var(--success); box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2); }
        .btn-snooze { background: var(--warning); color: #333; flex: 0.6; }
        .btn-block { width: 100%; margin-top: 10px; padding: 15px; font-size: 1.1rem; background: var(--main-color); }
        .btn-outline { background: white; border: 2px solid var(--main-color); color: var(--main-color); }
        .btn-email { background: #007bff; margin-top: 5px; }
        
        .snooze-options { display: flex; gap: 5px; animation: fadein 0.2s; }
        .btn-snooze-opt { background: #ffeeba; color: #333; font-size: 0.9rem; padding: 10px; border: 1px solid #ffc107; }

        /* INPUTOK */
        .form-group { margin-bottom: 20px; }
        label { font-size: 1rem; font-weight: bold; color: #333; display: block; margin-bottom: 6px; }
        .help-text { font-size: 0.85rem; color: var(--text-muted); font-style: italic; margin-bottom: 8px; display: block; line-height: 1.3; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: white; box-sizing: border-box; }
        
        /* M√ìDV√ÅLASZT√ìK */
        .type-selector { display: flex; gap: 10px; margin-bottom: 10px; }
        .type-option { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; font-weight: bold; color: #666; }
        .type-option.selected { border-color: var(--main-color); background: #eef4fb; color: var(--main-color); }
        .type-option.selected-acute { border-color: #fd7e14; background: #fff5eb; color: #fd7e14; }

        /* GYAKORIS√ÅG OPCI√ìK */
        .freq-options { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .week-grid { display: flex; justify-content: space-between; gap: 5px; }
        .week-day { flex: 1; text-align: center; padding: 8px 2px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: white; font-size: 0.9rem; }
        .week-day.checked { background: var(--main-color); color: white; border-color: var(--main-color); }

        /* STATISZTIKA */
        .stat-row { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .stat-header { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; }
        .progress-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s; }

        /* TABOK */
        .tab-content { display: none; animation: fadein 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadein { from { opacity:0; } to { opacity:1; } }

        /* MEN√ú */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #ddd; display: flex; height: 75px; z-index: 9999; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 0.75rem; cursor: pointer; }
        .nav-item.active { color: var(--main-color); font-weight: bold; background: #f0f7ff; }
        .icon { font-size: 1.6rem; margin-bottom: 4px; }
        
        /* JOGI MODAL */
        #legal-modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; max-width: 500px; text-align: center; max-height: 80vh; overflow-y: auto; }
        
        .alert-text { color: var(--danger); font-weight: bold; background: #fff0f0; padding: 10px; border-radius: 8px; border: 1px solid #ffcaca; }
        .info-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    </style>
</head>
<body>

<header>
    <h1>Gy√≥gyszernapl√≥</h1>
    <div class="doc-name" id="header-doc-name">H√°ziorvos: Nincs be√°ll√≠tva</div>
</header>

<div class="container">
    
    <!-- 1. MAI TEEND≈êK -->
    <div id="tab-today" class="tab-content active">
        <div id="today-header" style="text-align:center; margin-bottom:15px; font-size:0.95rem; color:#666; font-weight:bold;"></div>
        <div id="today-list"></div>
        <div style="text-align: center; margin-top: 50px; color: #888;" id="empty-msg">
            <div style="font-size: 4rem; margin-bottom: 10px;">‚úÖ</div>
            <div>M√°ra nincs (t√∂bb) teend≈ë.</div>
        </div>
    </div>

    <!-- 2. ORVOSI NAPL√ì -->
    <div id="tab-history" class="tab-content">
        <div class="card" style="border-left-color: var(--main-color);">
            <h3>üë®‚Äç‚öïÔ∏è Ter√°pia Elemz√©s (30 nap)</h3>
            <div id="dashboard-stats"></div>
        </div>

        <h3 style="margin: 20px 5px 10px;">Napl√≥ K√ºld√©se</h3>
        <div class="card" style="border-left: 5px solid #666;">
            <p style="font-size:0.9rem; margin-top:0;">K√ºldje el adatait orvos√°nak k√©t l√©p√©sben:</p>
            <button onclick="exportData()" class="btn-block" style="background:#444">üì• 1. Adatok let√∂lt√©se</button>
            <div class="help-text" style="text-align:center;">Ment√©s Excel (CSV) f√°jlba.</div>
            <button onclick="prepareEmail()" class="btn-block btn-email">üìß 2. Email meg√≠r√°sa</button>
            <div class="help-text" style="text-align:center;"><b>Ne felejtse el csatolni a f√°jlt!</b></div>
        </div>

        <h3 style="margin: 20px 5px 10px;">R√©szletes El≈ëzm√©nyek</h3>
        <table style="width:100%; font-size:0.85rem; border-collapse: collapse; background:white;">
            <thead style="background:#eee;"><tr><th style="padding:8px; text-align:left">Mikor</th><th style="padding:8px; text-align:left">Mit</th><th>Ok</th></tr></thead>
            <tbody id="history-table"></tbody>
        </table>
    </div>

    <!-- 3. BE√ÅLL√çT√ÅSOK -->
    <div id="tab-settings" class="tab-content">
        <div class="card">
            <h3>ü™™ Adatok</h3>
            <div class="type-selector">
                <div class="type-option selected" id="opt-adult" onclick="setPatientMode('adult')">Saj√°t magam</div>
                <div class="type-option" id="opt-child" onclick="setPatientMode('child')">Gyermekem</div>
            </div>
            <div class="form-group"><label id="lbl-pat-name">Beteg Neve</label><input type="text" id="pat-name" placeholder="pl. Kov√°cs J√°nos" onchange="saveSettings()"></div>
            <div class="form-group"><label>TAJ Sz√°m</label><input type="text" id="pat-taj" placeholder="000-000-000" onchange="saveSettings()"></div>
            <div class="form-group"><label>H√°ziorvos Neve</label><input type="text" id="doc-name" placeholder="pl. Dr. Minta √âva" onchange="saveSettings()"></div>
            <div class="form-group"><label>Rendel≈ë Email c√≠me</label><input type="email" id="doc-email" placeholder="orvos@pelda.hu" onchange="saveSettings()"></div>
        </div>

        <div class="card" style="border-left: 5px solid var(--success);">
            <h3 style="margin-top:0" id="form-title">üíä √öj gy√≥gyszer felv√©tele</h3>
            <input type="hidden" id="edit-id"> 
            
            <label>Ter√°pia t√≠pusa</label>
            <div class="type-selector">
                <div class="type-option selected" id="opt-chronic" onclick="setMedType('chronic')">√Ålland√≥ / Kr√≥nikus</div>
                <div class="type-option" id="opt-acute" onclick="setMedType('acute')">K√∫ra / Antibiotikum</div>
            </div>
            
            <div class="form-group"><label>Gy√≥gyszer neve</label><input type="text" id="new-name" placeholder="pl. D-Vitamin"></div>
            <div class="form-group"><label>D√≥zis / Mennyis√©g</label><input type="text" id="new-dose" placeholder="pl. 1 szem"></div>
            
            <div id="acute-settings" style="display:none; background:#fffbf2; padding:10px; border:1px dashed #fd7e14; border-radius:8px; margin-bottom:15px;">
                <label style="color:#d63384">K√∫ra kezdete</label><input type="date" id="new-start-date">
                <label style="color:#d63384">K√∫ra hossza (nap)</label><input type="number" id="new-duration" value="7">
            </div>

            <label>Szed√©s Gyakoris√°ga</label>
            <select id="freq-mode" onchange="toggleFreqMode()" style="margin-bottom:10px;">
                <option value="standard">Norm√°l (Naponta / H√©tk√∂znap / H√©tv√©ge)</option>
                <option value="weekly">Heti meghat√°rozott napokon (pl. H, Sze)</option>
                <option value="interval">Ciklikusan (Minden X. napon)</option>
            </select>

            <!-- Heti be√°ll√≠t√°s -->
            <div id="freq-weekly-panel" class="freq-options" style="display:none;">
                <div class="help-text">Jel√∂lje be a napokat:</div>
                <div class="week-grid">
                    <div class="week-day" onclick="toggleDay(this, 1)">H</div>
                    <div class="week-day" onclick="toggleDay(this, 2)">K</div>
                    <div class="week-day" onclick="toggleDay(this, 3)">Sze</div>
                    <div class="week-day" onclick="toggleDay(this, 4)">Cs</div>
                    <div class="week-day" onclick="toggleDay(this, 5)">P</div>
                    <div class="week-day" onclick="toggleDay(this, 6)">Szo</div>
                    <div class="week-day" onclick="toggleDay(this, 0)">V</div>
                </div>
                <input type="hidden" id="selected-days" value="">
            </div>

            <!-- Ciklikus be√°ll√≠t√°s -->
            <div id="freq-interval-panel" class="freq-options" style="display:none;">
                <div class="form-group">
                    <label>H√°ny naponta?</label>
                    <input type="number" id="freq-days" value="2" placeholder="pl. 2">
                </div>
                <div class="form-group">
                    <label>Kezd√©s / Utols√≥ bev√©tel d√°tuma</label>
                    <div class="help-text">Ehhez igaz√≠tjuk a ciklust.</div>
                    <input type="date" id="freq-start">
                </div>
            </div>
            
            <label>Id≈ëpontok (√ìra:Perc)</label>
            <div id="time-container"></div>
            <button class="btn-outline" style="padding:10px; width:100%; margin-top:5px;" onclick="addTimeField()">+ Id≈ëpont hozz√°ad√°sa</button>

            <button class="btn-block" id="save-btn" onclick="saveMedication()">Hozz√°ad√°s</button>
            <button id="cancel-btn" class="btn-block" style="background:#6c757d; display:none;" onclick="resetForm()">M√©gsem</button>
        </div>
        
        <h3 style="margin: 20px 10px 10px;">Mentett gy√≥gyszerek</h3>
        <div id="settings-list"></div>
        <div style="text-align:center; margin-top:40px; margin-bottom:20px;">
            <a href="#" onclick="hardReset()" style="color:#dc3545; font-size:0.9rem; text-decoration:underline; font-weight:bold;">‚ö†Ô∏è Adatok t√∂rl√©se (Reset)</a>
        </div>
    </div>

    <!-- 4. INFORM√ÅCI√ì TAB -->
    <div id="tab-info" class="tab-content">
        <div class="card">
            <h3>‚ÑπÔ∏è Inform√°ci√≥</h3>
            <div class="info-section">
                <div class="alert-text">
                    ‚ö†Ô∏è FONTOS: Az adatok csak a telefonj√°n vannak. B√∂ng√©sz√©si el≈ëzm√©nyek t√∂rl√©s√©vel elveszhetnek. T√∂lts√∂n le ment√©st rendszeresen!
                </div>
            </div>
            <div class="info-section">
                <h4>Hogyan m≈±k√∂dik?</h4>
                <ul style="padding-left:20px;">
                    <li><b>Gyakoris√°g:</b> Be√°ll√≠that napi, heti (pl. H√©tf≈ë, Cs√ºt√∂rt√∂k) vagy ciklikus (minden 3. nap) szed√©st.</li>
                    <li><b>Mai teend≈ëk:</b> Csak az aktu√°lis napi gy√≥gyszerek jelennek meg.</li>
                    <li><b>K√∫ra:</b> Antibiotikumn√°l a rendszer visszasz√°mol.</li>
                </ul>
            </div>
            <div class="info-section">
                <h4>Jogi Nyilatkozat</h4>
                <p>Ez a szoftver <b>NEM orvostechnikai eszk√∂z</b>. "Ahogy van" alapon, ingyenesen haszn√°lhat√≥. A pontos adagol√°s√©rt a felhaszn√°l√≥ felel.</p>
            </div>
            <div style="text-align:center; color:#888; font-size:0.8rem; margin-top:20px;">Verzi√≥: 0.9 </div>
        </div>
    </div>

</div>

<!-- JOGI MODAL -->
<div id="legal-modal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Figyelmeztet√©s</h3>
        <p>Ez az alkalmaz√°s <b>NEM orvostechnikai eszk√∂z</b>. Kiz√°r√≥lag √∂nmenedzsel√©st seg√≠t≈ë napl√≥.</p>
        <button class="btn-block" onclick="acceptLegal()">Elfogadom</button>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="switchTab('tab-today', this)"><span class="icon">üíä</span> Mai</div>
    <div class="nav-item" onclick="switchTab('tab-history', this)"><span class="icon">üìä</span> Orvosnak</div>
    <div class="nav-item" onclick="switchTab('tab-settings', this)"><span class="icon">‚öôÔ∏è</span> Be√°ll√≠t√°s</div>
    <div class="nav-item" onclick="switchTab('tab-info', this)"><span class="icon">‚ÑπÔ∏è</span> Inf√≥</div>
</nav>

<script>
    // --- ADATMODELL V9 ---
    let appData = {
        patient: { name: "", taj: "", docName: "", docEmail: "", isChild: false },
        medications: [], // {id, name, dose, type, startDate, duration, times:[{t, type}], freqMode, freqDays:[], intervalDays, cycleStartDate}
        history: [],
        legalAccepted: false
    };
    
    let dailyState = { date: "", items: [] };
    const STORAGE_KEY = 'med_diary_v9';

    function init() {
        // --- MIGR√ÅCI√ìS LOGIKA (V8 -> V9) ---
        const stored = localStorage.getItem(STORAGE_KEY);
        
        if (!stored) {
            // Ha m√©g nincs V9 adat, n√©zz√ºk meg, van-e V8
            const oldV8 = localStorage.getItem('med_diary_v8');
            if (oldV8) {
                try {
                    console.log("Migr√°ci√≥ V8-r√≥l V9-re...");
                    const parsedOld = JSON.parse(oldV8);
                    appData = { ...appData, ...parsedOld };
                    // Biztos√≠tjuk, hogy a V9-es mez≈ëk l√©tezzenek
                    if(!appData.patient) appData.patient = { name: "", taj: "", docName: "", docEmail: "", isChild: false };
                    
                    // Adatok ment√©se az √∫j V9 kulcsba
                    saveData();
                    
                    // Napi √°llapot √°thozatala is
                    const oldDaily = localStorage.getItem('med_daily_v8');
                    if(oldDaily) localStorage.setItem('med_daily_v9', oldDaily);
                    
                    alert("Az alkalmaz√°s sikeresen friss√ºlt a V9-es verzi√≥ra! A kor√°bbi adatai megmaradtak.");
                } catch(e) { 
                    console.error("Migr√°ci√≥s hiba:", e); 
                }
            }
        } else {
            // Norm√°l bet√∂lt√©s
            try {
                const parsed = JSON.parse(stored);
                appData = { ...appData, ...parsed };
                if(!appData.patient) appData.patient = { name: "", taj: "", docName: "", docEmail: "", isChild: false };
            } catch(e) { console.error(e); }
        }

        if(appData.legalAccepted) { document.getElementById('legal-modal').style.display = 'none'; }
        setPatientMode(appData.patient.isChild ? 'child' : 'adult');
        updateHeader();
        
        document.getElementById('pat-name').value = appData.patient.name || "";
        document.getElementById('pat-taj').value = appData.patient.taj || "";
        document.getElementById('doc-name').value = appData.patient.docName || "";
        document.getElementById('doc-email').value = appData.patient.docEmail || "";

        initDay(); renderAll();
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        localStorage.setItem('med_daily_v9', JSON.stringify(dailyState));
        updateHeader();
    }
    function acceptLegal() { appData.legalAccepted = true; document.getElementById('legal-modal').style.display = 'none'; saveData(); }
    function updateHeader() { document.getElementById('header-doc-name').innerText = "H√°ziorvos: " + (appData.patient.docName || "Nincs be√°ll√≠tva"); }

    function initDay() {
        const todayStr = new Date().toISOString().split('T')[0];
        const storedDaily = localStorage.getItem('med_daily_v9');
        if(storedDaily) { 
            const prevDaily = JSON.parse(storedDaily);
            if (prevDaily.date && prevDaily.date !== todayStr) { logMissedDoses(prevDaily); generateDailyTasks(todayStr); } 
            else { dailyState = prevDaily; }
        } else { generateDailyTasks(todayStr); }
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('today-header').innerText = new Date().toLocaleDateString('hu-HU', options);
    }

    function logMissedDoses(prevDaily) {
        prevDaily.items.forEach(item => {
            if(item.status === 'waiting') {
                appData.history.unshift({ date: prevDaily.date, time: item.time, name: item.name, dose: item.dose, status: 'Kihagyva' });
            }
        });
        if(appData.history.length > 500) appData.history = appData.history.slice(0, 500);
        saveData();
    }

    function generateDailyTasks(dateStr) {
        const today = new Date(dateStr);
        // H√©tf≈ë=1 ... Vas√°rnap=0 be√°ll√≠t√°sa
        const dayOfWeek = today.getDay(); // 0=Vas, 6=Szo
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        let items = [];

        appData.medications.forEach(med => {
            // 1. Akut k√∫ra ellen≈ërz√©s
            let isCourseActive = true;
            let courseDay = 0;
            if (med.type === 'acute') {
                const start = new Date(med.startDate);
                const diffTime = Math.abs(today - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const endDate = new Date(start);
                endDate.setDate(start.getDate() + (parseInt(med.duration)-1));
                if (today < start || today > endDate) isCourseActive = false;
                else courseDay = diffDays;
            }
            if (!isCourseActive) return;

            // 2. Gyakoris√°g ellen≈ërz√©s (NAPI SZINT)
            let isDayActive = false;
            let freqMode = med.freqMode || 'standard';

            if (freqMode === 'weekly') {
                // med.freqDays t√∂mbben sz√°mok (0-6)
                if (med.freqDays && med.freqDays.includes(dayOfWeek)) isDayActive = true;
            } else if (freqMode === 'interval') {
                if (med.cycleStartDate) {
                    const cycleStart = new Date(med.cycleStartDate);
                    // Napok sz√°ma start √≥ta
                    const diffTime = today - cycleStart;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays >= 0 && diffDays % med.intervalDays === 0) isDayActive = true;
                }
            } else {
                // Standard m√≥d: mindig akt√≠v, majd az id≈ëpontokn√°l sz≈±r√ºnk
                isDayActive = true;
            }

            if (!isDayActive) return;

            // 3. Id≈ëpontok gener√°l√°sa
            med.times.forEach(tObj => {
                let shouldAdd = false;
                // Ha standard m√≥d, akkor √©l a Weekday/Weekend sz≈±r√©s
                if (freqMode === 'standard') {
                    if (tObj.type === 'all') shouldAdd = true;
                    if (tObj.type === 'weekday' && !isWeekend) shouldAdd = true;
                    if (tObj.type === 'weekend' && isWeekend) shouldAdd = true;
                } else {
                    // Ha Heti vagy Ciklikus, akkor minden id≈ëpont j√°tszik ezen a napon
                    shouldAdd = true;
                }

                if (shouldAdd) {
                    items.push({
                        uid: Math.random().toString(36).substr(2, 9),
                        medId: med.id,
                        name: med.name,
                        dose: med.dose,
                        type: med.type,
                        courseInfo: med.type === 'acute' ? `${courseDay}. nap / ${med.duration}` : null,
                        time: tObj.t,
                        status: 'waiting'
                    });
                }
            });
        });

        items.sort((a,b) => a.time.localeCompare(b.time));
        dailyState = { date: dateStr, items: items };
        saveData();
    }

    // --- GYAKORIS√ÅG UI KEZEL√âS ---
    function toggleFreqMode() {
        const mode = document.getElementById('freq-mode').value;
        document.getElementById('freq-weekly-panel').style.display = mode === 'weekly' ? 'block' : 'none';
        document.getElementById('freq-interval-panel').style.display = mode === 'interval' ? 'block' : 'none';
        
        // Id≈ëpont sorokban a t√≠pus elrejt√©se ha nem standard
        document.querySelectorAll('.t-type').forEach(sel => {
            sel.style.display = mode === 'standard' ? 'block' : 'none';
        });
    }

    function toggleDay(el, dayIdx) {
        el.classList.toggle('checked');
        updateSelectedDays();
    }
    
    function updateSelectedDays() {
        let arr = [];
        document.querySelectorAll('.week-day.checked').forEach(el => {
            // A click handlerb≈ël a dayIdx-et neh√©z kinyerni √≠gy, ink√°bb dataset kellene, 
            // de egyszer≈±s√≠tve: a HTML sorrendb≈ël vagy onclick param√©terb≈ël.
            // DOM alap√∫:
            const txt = el.innerText;
            if(txt==='H') arr.push(1); if(txt==='K') arr.push(2); if(txt==='Sze') arr.push(3);
            if(txt==='Cs') arr.push(4); if(txt==='P') arr.push(5); if(txt==='Szo') arr.push(6); if(txt==='V') arr.push(0);
        });
        document.getElementById('selected-days').value = JSON.stringify(arr);
    }

    // --- BE√ÅLL√çT√ÅSOK ---
    function saveMedication() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('new-name').value;
        const dose = document.getElementById('new-dose').value;
        const freqMode = document.getElementById('freq-mode').value;
        
        let times = [];
        document.querySelectorAll('#time-container > div').forEach(row => {
            times.push({ t: row.querySelector('.t-val').value, type: row.querySelector('.t-type').value });
        });

        if(!name || times.length === 0) return alert('N√©v √©s id≈ëpont k√∂telez≈ë!');

        let medObj = { id: id ? parseInt(id) : Date.now(), name, dose, times, type: currentType, freqMode };

        if(currentType === 'acute') {
            medObj.startDate = document.getElementById('new-start-date').value;
            medObj.duration = document.getElementById('new-duration').value;
        }

        // Gyakoris√°g adatok
        if (freqMode === 'weekly') {
            updateSelectedDays();
            medObj.freqDays = JSON.parse(document.getElementById('selected-days').value || "[]");
            if(medObj.freqDays.length === 0) return alert('V√°lasszon legal√°bb egy napot!');
        } else if (freqMode === 'interval') {
            medObj.intervalDays = parseInt(document.getElementById('freq-days').value);
            medObj.cycleStartDate = document.getElementById('freq-start').value;
            if(!medObj.cycleStartDate) return alert('Kezd≈ë d√°tum k√∂telez≈ë!');
        }

        if(id) {
            const idx = appData.medications.findIndex(m => m.id == id);
            appData.medications[idx] = medObj;
            dailyState.items = dailyState.items.filter(i => !(i.medId == id && i.status == 'waiting'));
        } else {
            appData.medications.push(medObj);
        }
        
        generateDailyTasks(dailyState.date);
        saveData(); resetForm(); renderAll(); alert('R√∂gz√≠tve!'); switchTab('tab-settings', document.querySelectorAll('.nav-item')[2]);
    }

    function editMed(id) {
        const med = appData.medications.find(m => m.id == id);
        if(!med) return;
        document.getElementById('edit-id').value = med.id;
        document.getElementById('new-name').value = med.name;
        document.getElementById('new-dose').value = med.dose;
        setMedType(med.type || 'chronic');
        
        if(med.type === 'acute') {
            document.getElementById('new-start-date').value = med.startDate;
            document.getElementById('new-duration').value = med.duration;
        }

        // Gyakoris√°g bet√∂lt√©se
        document.getElementById('freq-mode').value = med.freqMode || 'standard';
        toggleFreqMode();
        
        if (med.freqMode === 'weekly') {
            document.querySelectorAll('.week-day').forEach(el => {
                el.classList.remove('checked');
                const txt = el.innerText;
                let d = -1;
                if(txt==='H') d=1; if(txt==='K') d=2; if(txt==='Sze') d=3;
                if(txt==='Cs') d=4; if(txt==='P') d=5; if(txt==='Szo') d=6; if(txt==='V') d=0;
                if(med.freqDays && med.freqDays.includes(d)) el.classList.add('checked');
            });
            updateSelectedDays();
        } else if (med.freqMode === 'interval') {
            document.getElementById('freq-days').value = med.intervalDays || 2;
            document.getElementById('freq-start').value = med.cycleStartDate || "";
        }

        document.getElementById('time-container').innerHTML = '';
        med.times.forEach(t => addTimeField(t.t, t.type));
        
        // Ha nem standard, a timefield l√©trehoz√°sa ut√°n el kell rejteni a selecteket
        toggleFreqMode();

        document.getElementById('form-title').innerText = 'Szerkeszt√©s';
        document.getElementById('save-btn').innerText = 'Ment√©s';
        document.getElementById('cancel-btn').style.display = 'block';
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('new-name').value = '';
        document.getElementById('new-dose').value = '';
        document.getElementById('time-container').innerHTML = '';
        document.getElementById('freq-mode').value = 'standard';
        document.querySelectorAll('.week-day').forEach(e => e.classList.remove('checked'));
        document.getElementById('freq-days').value = 2;
        document.getElementById('freq-start').value = '';
        setMedType('chronic');
        addTimeField();
        toggleFreqMode();
        document.getElementById('form-title').innerText = 'üíä √öj gy√≥gyszer';
        document.getElementById('save-btn').innerText = 'Hozz√°ad√°s';
        document.getElementById('cancel-btn').style.display = 'none';
    }

    // --- EGY√âB F√úGGV√âNYEK (MEGEGYEZNEK A V8-AL) ---
    function setPatientMode(mode) {
        const isChild = (mode === 'child'); appData.patient.isChild = isChild;
        document.getElementById('opt-adult').className = isChild ? 'type-option' : 'type-option selected';
        document.getElementById('opt-child').className = isChild ? 'type-option selected' : 'type-option';
        document.getElementById('lbl-pat-name').innerText = isChild ? "Gyermek Neve" : "Beteg Neve";
        saveSettings();
    }
    function saveSettings() {
        appData.patient.name = document.getElementById('pat-name').value;
        appData.patient.taj = document.getElementById('pat-taj').value;
        appData.patient.docName = document.getElementById('doc-name').value;
        appData.patient.docEmail = document.getElementById('doc-email').value;
        saveData();
    }
    function setMedType(type) {
        currentType = type;
        document.querySelectorAll('.type-option').forEach(el => {
           if(el.id.startsWith('opt-c') || el.id.startsWith('opt-a')) el.classList.remove('selected', 'selected-acute');
        });
        if(type === 'chronic') { document.getElementById('opt-chronic').classList.add('selected'); document.getElementById('acute-settings').style.display = 'none'; } 
        else { document.getElementById('opt-acute').classList.add('selected-acute'); document.getElementById('acute-settings').style.display = 'block'; document.getElementById('new-start-date').value = new Date().toISOString().split('T')[0]; }
    }
    function addTimeField(val="08:00", type="all") {
        const div = document.createElement('div');
        div.className = 'type-selector'; div.style.marginBottom = "5px";
        div.innerHTML = `<input type="time" class="t-val" value="${val}"><select class="t-type"><option value="all" ${type=='all'?'selected':''}>Minden nap</option><option value="weekday" ${type=='weekday'?'selected':''}>H√©tk√∂znap</option><option value="weekend" ${type=='weekend'?'selected':''}>H√©tv√©ge</option></select><button class="btn-delete" style="flex:0.3; margin:0;" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('time-container').appendChild(div);
        toggleFreqMode(); // Friss√≠teni a l√°that√≥s√°got
    }
    function deleteMed(id) { if(confirm('Biztosan t√∂rli?')) { appData.medications = appData.medications.filter(m => m.id != id); dailyState.items = dailyState.items.filter(i => i.medId != id); saveData(); renderAll(); } }
    function takeMed(uid) { const item = dailyState.items.find(i => i.uid == uid); if(item) { item.status = 'done'; appData.history.unshift({ date: dailyState.date, time: new Date().toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'}), name: item.name, dose: item.dose, status: 'Bev√©ve' }); saveData(); renderAll(); } }
    function showSnooze(uid) { document.getElementById(`btn-group-${uid}`).innerHTML = `<div class="snooze-options"><button class="btn-snooze-opt" onclick="applySnooze('${uid}', 15)">+15p</button><button class="btn-snooze-opt" onclick="applySnooze('${uid}', 30)">+30p</button><button class="btn-snooze-opt" onclick="applySnooze('${uid}', 60)">+1√≥</button><button class="btn-snooze-opt" style="background:#ddd" onclick="renderToday()">X</button></div>`; }
    function applySnooze(uid, mins) { const item = dailyState.items.find(i => i.uid == uid); if(item) { let [h, m] = item.time.split(':').map(Number); let d = new Date(); d.setHours(h, m + mins); let nh = String(d.getHours()).padStart(2,'0'); let nm = String(d.getMinutes()).padStart(2,'0'); item.time = `${nh}:${nm}`; saveData(); renderAll(); } }
    function renderAll() { renderToday(); renderSettingsList(); renderHistory(); renderDashboard(); }
    function renderToday() {
        const list = document.getElementById('today-list'); list.innerHTML = '';
        const now = new Date(); const currentHm = now.getHours() * 60 + now.getMinutes(); let hasItems = false;
        dailyState.items.forEach(item => {
            hasItems = true; const div = document.createElement('div'); let statusClass = 'status-waiting';
            let [h, m] = item.time.split(':').map(Number);
            if(item.status == 'waiting' && currentHm >= (h*60+m)) statusClass = 'status-due';
            if(item.status == 'done') statusClass = 'status-done';
            let typeClass = item.type === 'acute' ? 'type-acute' : '';
            let acuteBadge = item.type === 'acute' ? `<div class="acute-badge">K√∫ra</div>` : '';
            let courseText = item.courseInfo ? `<div class="course-info">üìÖ ${item.courseInfo}</div>` : '';
            let btns = item.status == 'waiting' ? `<div class="btn-group" id="btn-group-${item.uid}"><button class="btn-take" onclick="takeMed('${item.uid}')">‚úî Bevettem</button><button class="btn-snooze" onclick="showSnooze('${item.uid}')">üí§ Halaszt</button></div>` : `<div style="color:green; font-weight:bold; margin-top:10px;">‚úÖ BEV√âVE</div>`;
            div.className = `card ${statusClass} ${typeClass}`;
            div.innerHTML = `${acuteBadge}<div class="med-header"><div><div class="med-name">${item.name}</div><div class="med-details">${item.dose}</div>${courseText}</div><div class="med-time">${item.time}</div></div>${btns}`;
            list.appendChild(div);
        });
        document.getElementById('empty-msg').style.display = hasItems ? 'none' : 'block';
    }
    function renderSettingsList() {
        const list = document.getElementById('settings-list'); list.innerHTML = '';
        appData.medications.forEach(m => {
            let tags = m.times.map(t => `<span style="background:#eee; padding:2px 5px; border-radius:4px; font-size:0.8rem; margin-right:5px;">‚è∞ ${t.t}</span>`).join('');
            let info = '';
            if (m.freqMode === 'weekly') {
                let days = m.freqDays.map(d => ['V','H','K','Sze','Cs','P','Szo'][d]).join(', ');
                info = `<div style="font-size:0.8rem; color:#666;">Heti: ${days}</div>`;
            } else if (m.freqMode === 'interval') {
                info = `<div style="font-size:0.8rem; color:#666;">Minden ${m.intervalDays}. napon</div>`;
            }
            let typeLabel = m.type === 'acute' ? '<b style="color:#fd7e14">[K√öRA]</b>' : '<b>[Kr√≥nikus]</b>';
            list.innerHTML += `<div class="card" style="padding:10px;"><div style="display:flex; justify-content:space-between;"><div>${typeLabel} ${m.name} (${m.dose})</div><div><button class="btn-edit btn-action" onclick="editMed(${m.id})">‚úèÔ∏è</button><button class="btn-delete btn-action" onclick="deleteMed(${m.id})">üóëÔ∏è</button></div></div>${info}<div style="margin-top:5px;">${tags}</div></div>`;
        });
    }
    function renderHistory() {
        const tbody = document.getElementById('history-table'); tbody.innerHTML = '';
        appData.history.slice(0, 30).forEach(h => {
            let color = h.status === 'Bev√©ve' ? 'green' : (h.status === 'Kihagyva' ? 'red' : 'orange');
            tbody.innerHTML += `<tr><td>${h.date}<br>${h.time}</td><td><b>${h.name}</b><br><small>${h.dose || ''}</small></td><td style="color:${color}">${h.status === 'Bev√©ve' ? '‚úî' : '‚ùå'}</td></tr>`;
        });
    }
    function calculateStats() {
        let stats = {};
        appData.history.forEach(h => { if(!stats[h.name]) stats[h.name] = { total: 0, taken: 0 }; stats[h.name].total++; if(h.status === 'Bev√©ve') stats[h.name].taken++; });
        return stats;
    }
    function renderDashboard() {
        const div = document.getElementById('dashboard-stats'); div.innerHTML = '';
        let stats = calculateStats();
        if(Object.keys(stats).length === 0) { div.innerHTML = '<div style="text-align:center; color:#777;">M√©g nincs el√©g adat a statisztik√°hoz.</div>'; return; }
        for (const [name, data] of Object.entries(stats)) {
            let percent = Math.round((data.taken / data.total) * 100);
            let color = percent < 70 ? '#dc3545' : (percent < 90 ? '#ffc107' : '#28a745');
            div.innerHTML += `<div class="stat-row"><div class="stat-header"><span>${name}</span><span style="color:${color}">${percent}% (${data.taken}/${data.total})</span></div><div class="progress-bg"><div class="progress-fill" style="width:${percent}%; background:${color}"></div></div></div>`;
        }
    }
    window.switchTab = function(tabId, navElem) { document.querySelectorAll('.tab-content').forEach(d => {d.style.display='none'; d.classList.remove('active')}); document.getElementById(tabId).style.display='block'; setTimeout(() => document.getElementById(tabId).classList.add('active'), 10); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if(navElem) navElem.classList.add('active'); window.scrollTo(0,0); }
    window.exportData = function() {
        const name = (appData.patient.name || "Beteg").replace(/ /g, "_"); const date = new Date().toISOString().split('T')[0]; const filename = `Naplo_${name}_${date}.csv`;
        let csv = "\uFEFFBETEG ADATAI\nNev:," + (appData.patient.name||'-') + "\nTAJ:," + (appData.patient.taj||'-') + "\n\n--- STATISZTIKA ---\nGyogyszer,Osszes,Bevett,Sikeresseg %\n";
        let stats = calculateStats(); for (const [m, d] of Object.entries(stats)) { csv += `${m},${d.total},${d.taken},${Math.round((d.taken/d.total)*100)}%\n`; }
        csv += "\n--- RESZLETES NAPLO ---\nDatum,Ido,Gyogyszer,Dozis,Statusz\n";
        appData.history.forEach(r => { let d = r.dose || ""; if(!d) { let m=appData.medications.find(x=>x.name===r.name); if(m) d=m.dose; } csv += `${r.date},${r.time},${r.name},${d},${r.status}\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); alert("F√°jl let√∂ltve! Most k√ºldje el emailben.");
    }
    window.prepareEmail = function() { const email = appData.patient.docEmail; if(!email) return alert("Adja meg az orvos email c√≠m√©t!"); const name = appData.patient.name || "[N√©v]"; window.location.href = `mailto:${email}?subject=Gy√≥gyszernapl√≥: ${name}&body=Tisztelt Doktor √ör/N≈ë!%0D%0A%0D%0AMell√©kelten k√ºld√∂m a gy√≥gyszernapl√≥mat.%0D%0A%0D%0ABeteg: ${name}`; }
    window.hardReset = function() { if(confirm("Minden adat t√∂rl√©se?")) { localStorage.removeItem(STORAGE_KEY); localStorage.removeItem('med_daily_v9'); location.reload(); } }

    if(document.getElementById('time-container').children.length === 0) addTimeField();
    init(); setInterval(() => { initDay(); renderToday(); }, 60000);
</script>
</body>
</html>
